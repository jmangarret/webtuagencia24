var qq=qq||{};qq.FileUploader=function(d){var a=d.labels,c="";if(d.size.width){c+="width: "+d.size.width}if(d.size.height){c+="height: "+d.size.height}this._options={element:null,action:"/server/upload",params:{},allowedExtensions:[],sizeLimit:0,onSubmit:function(f,e){},onComplete:function(g,f,e){},template:'<div class="qq-uploader"><div class="qq-upload-drop-area" style="'+c+'"><table style="width: 100%; height: 100%;"><tr><td><div class="qq-label-drop">'+a.labelDrop+'</div><div class="qq-upload-button">'+a.labelButton+'</div></td></tr></table></div><ul class="qq-upload-list"></ul></div>',fileTemplate:'<li><span class="qq-upload-file"></span><span class="qq-upload-spinner">&nbsp;</span><span class="qq-upload-size"></span><a class="qq-upload-cancel" href="#">'+a.labelCancel+'</a><span class="qq-upload-failed-text">'+a.labelFailed+"</span></li>",classes:{button:"qq-upload-button",drop:"qq-upload-drop-area",dropActive:"qq-upload-drop-area-active",list:"qq-upload-list",dragEnter:"qq-drag-enter",labelDrop:"qq-label-drop",file:"qq-upload-file",spinner:"qq-upload-spinner",size:"qq-upload-size",cancel:"qq-upload-cancel",success:"qq-upload-success",fail:"qq-upload-fail"},messages:{typeError:"{file} has invalid extension. Only {extensions} are allowed.",sizeError:"{file} is too large, maximum file size is {sizeLimit}.",emptyError:"{file} is empty, please select files again without it."},showMessage:function(e){alert(e)}};qq.extend(this._options,d);this._element=this._options.element;if(this._element.nodeType!=1){throw new Error("element param of FileUploader should be dom node")}this._element.innerHTML=this._options.template;this._filesInProgress=0;this._classes=this._options.classes;this._handler=this._createUploadHandler();this._bindCancelEvent();var b=this;this._button=new qq.UploadButton({element:this._getElement("button"),multiple:qq.UploadHandlerXhr.isSupported(),onChange:function(e){b._onInputChange(e)}});this._setupDragDrop()};qq.FileUploader.prototype={setParams:function(a){this._options.params=a},isUploading:function(){return !!this._filesInProgress},_getElement:function(c,b){if(typeof c=="string"){b=c;c=this._element}var a=qq.getByClass(c,this._options.classes[b])[0];if(!a){throw new Error("element not found "+b)}return a},_error:function(b,c){var a=this._options.messages[b];a=a.replace("{file}",this._formatFileName(c));a=a.replace("{extensions}",this._options.allowedExtensions.join(", "));a=a.replace("{sizeLimit}",this._formatSize(this._options.sizeLimit));this._options.showMessage(a)},_formatFileName:function(a){if(a.length>33){a=a.slice(0,19)+"..."+a.slice(-13)}return a},_isAllowedExtension:function(d){var b=(-1!==d.indexOf("."))?d.replace(/.*[.]/,"").toLowerCase():"";var c=this._options.allowedExtensions;if(!c.length){return true}for(var a=0;a<c.length;a++){if(c[a].toLowerCase()==b){return true}}return false},_setupDragDrop:function(){function e(i){var h=i.dataTransfer,g=navigator.userAgent.indexOf("AppleWebKit")>-1;return h&&h.effectAllowed!="none"&&(h.files||(!g&&h.types.contains&&h.types.contains("Files")))}var b=this,c=this._getElement("drop"),f=this._getElement("labelDrop"),d=this._getElement("button");f.style.display="none";d.style.display="block";var a;qq.attach(document,"dragenter",function(g){g.preventDefault()});qq.attach(document,"dragover",function(h){if(e(h)){if(a){clearTimeout(a)}qq.addClass(c,b._classes.dragEnter);f.style.display="block";d.style.display="none";if(c==h.target||qq.contains(c,h.target)){var g=h.dataTransfer.effectAllowed;if(g=="move"||g=="linkMove"){h.dataTransfer.dropEffect="move"}else{h.dataTransfer.dropEffect="copy"}qq.addClass(c,b._classes.dropActive);h.stopPropagation()}else{h.dataTransfer.dropEffect="none"}h.preventDefault()}});qq.attach(document,"dragleave",function(g){if(e(g)){if(c==g.target||qq.contains(c,g.target)){qq.removeClass(c,b._classes.dropActive);g.stopPropagation()}else{if(a){clearTimeout(a)}a=setTimeout(function(){f.style.display="none";d.style.display="block";qq.removeClass(c,b._classes.dragEnter)},10)}}});qq.attach(c,"drop",function(g){f.style.display="none";d.style.display="block";qq.removeClass(c,b._classes.dragEnter);b._uploadFileList(g.dataTransfer.files);g.preventDefault()})},_createUploadHandler:function(){var a=this,c;if(qq.UploadHandlerXhr.isSupported()){c="UploadHandlerXhr"}else{c="UploadHandlerForm"}var b=new qq[c]({action:this._options.action,onProgress:function(g,f,d,e){a._updateProgress(g,d,e)},onComplete:function(g,f,d){a._filesInProgress--;var e=a._getItemByFileId(g);qq.remove(a._getElement(e,"cancel"));qq.remove(a._getElement(e,"spinner"));if(d.success){qq.addClass(e,a._classes.success)}else{qq.addClass(e,a._classes.fail);if(d.error){a._options.showMessage(d.error)}}a._options.onComplete(g,f,d)}});return b},_onInputChange:function(a){if(this._handler instanceof qq.UploadHandlerXhr){this._uploadFileList(a.files)}else{if(this._validateFile(a)){this._uploadFile(a)}}this._button.reset()},_uploadFileList:function(c){var b=true;var a=c.length;while(a--){if(!this._validateFile(c[a])){b=false;break}}if(b){var a=c.length;while(a--){this._uploadFile(c[a])}}},_uploadFile:function(a){var c=this._handler.add(a);var b=this._handler.getName(c);this._options.onSubmit(c,b);this._addToList(c,b);this._handler.upload(c,this._options.params)},_validateFile:function(c){var a,b;if(c.value){a=c.value.replace(/.*(\/|\\)/,"")}else{a=c.fileName!=null?c.fileName:c.name;b=c.fileSize!=null?c.fileSize:c.size}if(!this._isAllowedExtension(a)){this._error("typeError",a);return false}else{if(b===0){this._error("emptyError",a);return false}else{if(b&&this._options.sizeLimit&&b>this._options.sizeLimit){this._error("sizeError",a);return false}}}return true},_addToList:function(d,c){var a=qq.toElement(this._options.fileTemplate);a.qqFileId=d;var b=this._getElement(a,"file");qq.setText(b,this._formatFileName(c));this._getElement(a,"size").style.display="none";this._getElement("list").appendChild(a);this._filesInProgress++},_updateProgress:function(f,a,d){var c=this._getItemByFileId(f);var b=this._getElement(c,"size");b.style.display="inline";var e;if(a!=d){e=Math.round(a/d*100)+"% from "+this._formatSize(d)}else{e=this._formatSize(d)}qq.setText(b,e)},_formatSize:function(a){var b=-1;do{a=a/1024;b++}while(a>99);return Math.max(a,0.1).toFixed(1)+["kB","MB","GB","TB","PB","EB"][b]},_getItemByFileId:function(b){var a=this._getElement("list").firstChild;while(a){if(a.qqFileId==b){return a}a=a.nextSibling}},_bindCancelEvent:function(){var a=this,b=this._getElement("list");qq.attach(b,"click",function(f){f=f||window.event;var d=f.target||f.srcElement;if(qq.hasClass(d,a._classes.cancel)){qq.preventDefault(f);var c=d.parentNode;a._handler.cancel(c.qqFileId);qq.remove(c)}})}};qq.UploadButton=function(a){this._options={element:null,multiple:false,name:"file",onChange:function(b){},hoverClass:"qq-upload-button-hover",focusClass:"qq-upload-button-focus"};qq.extend(this._options,a);this._element=this._options.element;qq.css(this._element,{position:"relative",overflow:"hidden",direction:"ltr"});this._input=this._createInput()};qq.UploadButton.prototype={getInput:function(){return this._input},reset:function(){if(this._input.parentNode){qq.remove(this._input)}qq.removeClass(this._element,this._options.focusClass);this._input=this._createInput()},_createInput:function(){var b=document.createElement("input");if(this._options.multiple){b.setAttribute("multiple","multiple")}b.setAttribute("type","file");b.setAttribute("name",this._options.name);qq.css(b,{position:"absolute",right:0,top:0,zIndex:1,fontSize:"460px",margin:0,padding:0,cursor:"pointer",opacity:0});this._element.appendChild(b);var a=this;qq.attach(b,"change",function(){a._options.onChange(b)});qq.attach(b,"mouseover",function(){qq.addClass(a._element,a._options.hoverClass)});qq.attach(b,"mouseout",function(){qq.removeClass(a._element,a._options.hoverClass)});qq.attach(b,"focus",function(){qq.addClass(a._element,a._options.focusClass)});qq.attach(b,"blur",function(){qq.removeClass(a._element,a._options.focusClass)});if(window.attachEvent){b.setAttribute("tabIndex","-1")}return b}};qq.UploadHandlerForm=function(a){this._options={action:"/upload",onComplete:function(d,c,b){}};qq.extend(this._options,a);this._inputs={}};qq.UploadHandlerForm.prototype={add:function(a){a.setAttribute("name","qqfile");var b="qq-upload-handler-iframe"+qq.getUniqueId();this._inputs[b]=a;if(a.parentNode){qq.remove(a)}return b},upload:function(g,e){var b=this._inputs[g];if(!b){throw new Error("file with passed id was not added, or already uploaded or cancelled")}var f=this.getName(g);var c=this._createIframe(g);var d=this._createForm(c,e);d.appendChild(b);var a=this;this._attachLoadEvent(c,function(){a._options.onComplete(g,f,a._getIframeContentJSON(c));delete a._inputs[g];setTimeout(function(){qq.remove(c)},1)});d.submit();qq.remove(d);return g},cancel:function(b){if(b in this._inputs){delete this._inputs[b]}var a=document.getElementById(b);if(a){a.setAttribute("src","javascript:false;");qq.remove(a)}},getName:function(a){return this._inputs[a].value.replace(/.*(\/|\\)/,"")},_attachLoadEvent:function(a,b){qq.attach(a,"load",function(){if(!a.parentNode){return}if(a.contentDocument&&a.contentDocument.body&&a.contentDocument.body.innerHTML=="false"){return}b()})},_getIframeContentJSON:function(iframe){var doc=iframe.contentDocument?iframe.contentDocument:iframe.contentWindow.document,response;try{response=eval("("+doc.body.innerHTML+")")}catch(err){response={}}return response},_createIframe:function(b){var a=qq.toElement('<iframe src="javascript:false;" name="'+b+'" />');a.setAttribute("id",b);a.style.display="none";document.body.appendChild(a);return a},_createForm:function(b,d){var c=qq.toElement('<form method="post" enctype="multipart/form-data"></form>');var e="?";for(var a in d){e+="&"+a+"="+encodeURIComponent(d[a])}c.setAttribute("action",this._options.action+e);c.setAttribute("target",b.name);c.style.display="none";document.body.appendChild(c);return c}};qq.UploadHandlerXhr=function(a){this._options={action:"/upload",onProgress:function(e,d,b,c){},onComplete:function(d,c,b){}};qq.extend(this._options,a);this._files=[];this._xhrs=[]};qq.UploadHandlerXhr.isSupported=function(){return typeof File!="undefined"&&typeof(new XMLHttpRequest()).upload!="undefined"};qq.UploadHandlerXhr.prototype={add:function(a){return this._files.push(a)-1},upload:function(id,params){var file=this._files[id],name=this.getName(id),size=this.getSize(id);if(!file){throw new Error("file with passed id was not added, or already uploaded or cancelled")}var xhr=this._xhrs[id]=new XMLHttpRequest();var self=this;xhr.upload.onprogress=function(e){if(e.lengthComputable){self._options.onProgress(id,name,e.loaded,e.total)}};xhr.onreadystatechange=function(){if(!self._files[id]){return}if(xhr.readyState==4){self._options.onProgress(id,name,size,size);if(xhr.status==200){var response;try{response=eval("("+xhr.responseText+")")}catch(err){response={}}self._options.onComplete(id,name,response)}else{self._options.onComplete(id,name,{})}self._files[id]=null;self._xhrs[id]=null}};var queryString="&qqfile="+encodeURIComponent(name);for(var key in params){queryString+="&"+key+"="+encodeURIComponent(params[key])}xhr.open("POST",this._options.action+queryString,true);xhr.send(file)},cancel:function(a){this._files[a]=null;if(this._xhrs[a]){this._xhrs[a].abort();this._xhrs[a]=null}},getName:function(b){var a=this._files[b];return a.fileName!=null?a.fileName:a.name},getSize:function(b){var a=this._files[b];return a.fileSize!=null?a.fileSize:a.size}};var qq=qq||{};qq.extend=function(b,a){for(var c in a){b[c]=a[c]}};qq.getUniqueId=(function(){var a=0;return function(){return a++}})();qq.attach=function(a,c,b){if(a.addEventListener){a.addEventListener(c,b,false)}else{if(a.attachEvent){a.attachEvent("on"+c,b)}}};qq.detach=function(a,c,b){if(a.removeEventListener){a.removeEventListener(c,b,false)}else{if(a.attachEvent){a.detachEvent("on"+c,b)}}};qq.preventDefault=function(a){if(a.preventDefault){a.preventDefault()}else{a.returnValue=false}};qq.insertBefore=function(d,c){c.parentNode.insertBefore(d,c)};qq.remove=function(a){a.parentNode.removeChild(a)};qq.contains=function(b,a){if(b.contains){return b.contains(a)}else{return !!(a.compareDocumentPosition(b)&8)}};qq.toElement=(function(){var a=document.createElement("div");return function(c){a.innerHTML=c;var b=a.firstChild;a.removeChild(b);return b}})();qq.css=function(a,b){if(b.opacity!=null){if(typeof a.style.opacity!="string"&&typeof(a.filters)!="undefined"){b.filter="alpha(opacity="+Math.round(100*b.opacity)+")"}}qq.extend(a.style,b)};qq.hasClass=function(b,a){var c=new RegExp("(^| )"+a+"( |$)");return c.test(b.className)};qq.addClass=function(b,a){if(!qq.hasClass(b,a)){b.className+=" "+a}};qq.removeClass=function(b,a){var c=new RegExp("(^| )"+a+"( |$)");b.className=b.className.replace(c," ").replace(/^\s+|\s+$/g,"")};qq.setText=function(a,b){a.innerText=b;a.textContent=b};qq.children=function(b){var a=[],c=b.firstChild;while(c){if(c.nodeType==1){a.push(c)}c=c.nextSibling}return a};qq.getByClass=function(d,e){if(d.querySelectorAll){return d.querySelectorAll("."+e)}var b=[];var f=d.getElementsByTagName("*");var a=f.length;for(var c=0;c<a;c++){if(qq.hasClass(f[c],e)){b.push(f[c])}}return b};var _jCrop=function(m){var h="#"+m.id+"-image",d=jQuery,j,i,l,f=d("#"+m.preview).width()/d("#"+m.preview).height();var a=function(p){if(parseInt(p.w)>0){var o=d("#"+m.preview).width()/p.w;var n=d("#"+m.preview).height()/p.h;d("#"+m.preview+" img").css({width:Math.round(o*j)+"px",height:Math.round(n*i)+"px",marginLeft:"-"+Math.round(o*p.x)+"px",marginTop:"-"+Math.round(n*p.y)+"px"})}};var k=function(n){d("#"+m.id+"_x").val(n.x);d("#"+m.id+"_y").val(n.y);d("#"+m.id+"_w").val(n.w);d("#"+m.id+"_h").val(n.h)};d("input[id^="+m.aspectratio+"]").change(function(){l.setOptions(this.checked?{aspectRatio:f}:{aspectRatio:0});l.focus()});var g="";g+="<input type='hidden' id='"+m.id+"_x' name='"+m.id+"_x' value='' />";g+="<input type='hidden' id='"+m.id+"_y' name='"+m.id+"_y' value='' />";g+="<input type='hidden' id='"+m.id+"_w' name='"+m.id+"_w' value='' />";g+="<input type='hidden' id='"+m.id+"_h' name='"+m.id+"_h' value='' />";if(m.upload){var e=new qq.FileUploader({element:d(h)[0],allowedExtensions:m.extensions,action:m.action,debug:false,labels:m.labels,size:m.size,onComplete:function(s,r,o){var q="",n=e._handler._files?e._handler._files.length:e._handler._inputs.length;for(var p=0;p<n;p++){e._handler.cancel(p)}if(o.error==undefined){d(h+" div.qq-upload-drop-area").removeClass("qq-upload-drop-area");d(h+" td").html("<div class='image-loading'></div>");q="<input type='hidden' id='"+m.id+"' name='"+m.id+"' value='"+r+"' />";q+=g;q+="<img src='../tmp/"+r+"' style='display:none;' />";d(h).append(q);d(h+" img")[0].onload=function(){var v=d("#"+m.preview),u=v.width(),y=v.height();d("div.qq-upload-button").show().click(function(){v.html("<table width='100%' height='100%'><tr><td valign='middle'><div class='image-loading'></div></td></tr></table>");var w={};w.rotator=d("#rotator").val();w.image=d("#"+m.id).val();w[m.id+"_x"]=d("#"+m.id+"_x").val();w[m.id+"_y"]=d("#"+m.id+"_y").val();w[m.id+"_w"]=d("#"+m.id+"_w").val();w[m.id+"_h"]=d("#"+m.id+"_h").val();d.ajax({type:"POST",url:"index.php?option=com_rotator&controller=banner&task=saveImage&format=raw",data:w,dataType:"json",success:function(A){if(A.error){alert(A.error)}else{var B="<input type='hidden' id='"+m.id+"' name='"+m.id+"' value='"+A.success+"' />",C=d("div.d-ratio").html();B+=g;B+="<img class='ld-banner' src='../tmp/"+A.success+"' width='"+u+"' height='"+y+"' />";d(h).parents("tr").remove();d("div.qq-upload-button").remove();d(document.body).append('<div id="tmp-load" style="display:none">'+B+"<div>");d("img.ld-banner")[0].onload=function(){v.html(d("#tmp-load").html());d("#tmp-load").remove();if(m.thumb.width!=0&&m.thumb.height!=0){B="<legend>"+v.prev().html()+"</legend>";B+='<table class="banner-thumb" width="100%"><tr>';B+='<td width="60%">Banner</td>';B+="<td>Thumb</td></tr><tr>";B+='<td class="img-banner"></td>';B+='<td><div id="'+m.preview+'-thumb" class="preview-img" ';B+='style="height:'+m.thumb.height+"px;";B+="width:"+m.thumb.width+"px;";B+='overflow:hidden;">';B+="<img src='../tmp/"+A.success+"' width='";B+=m.thumb.width+"' height='"+m.thumb.height+"' />";B+="</div></td></tr>";B+='<tr><td colspan="2"><div class="d-ratio">'+C+"</div>";B+="</td></tr></table>";var D=v.clone(true);v.parent().html(B).find(".img-banner").append(D);f=m.thumb.width/m.thumb.height;m.preview+="-thumb";d("img.ld-banner").Jcrop({onChange:z,onSelect:z,aspectRatio:f},function(){var E=this.getBounds();l=this;j=E[0];i=E[1]});d("input[id^="+m.aspectratio+"]").change(function(){l.setOptions(this.checked?{aspectRatio:f}:{aspectRatio:0});l.focus()})}};d("input:disabled, select:disabled, textarea:disabled").attr("disabled",false);d("body").scrollTop(100)}}})});d(h+" div.qq-uploader").remove();d(h+" div.qq-upload-list").remove();v.html("<img src='../tmp/"+r+"' width='"+u+"' height='"+y+"' />");var x=d(h),t=x.outerWidth();x.css("width",t);x.css({overflow:"auto",position:"relative",maxHeight:d(window).height()+"px",height:"100%"});var z=function(w){k(w);a(w)};d(h+" img").show().Jcrop({onChange:z,onSelect:z,aspectRatio:f},function(){var w=this.getBounds();l=this;j=w[0];i=w[1];d("input[id^="+m.aspectratio+"]").attr("disabled","")})}}}})}else{var c=true;var b=function(o){if(c){var n=g;n+='<img src="'+d("div.preview-img > img").attr("src")+'" />';d("#"+m.preview).html(n);c=false}k(o);a(o)};f=m.thumb.width/m.thumb.height;d("#"+m.preview+" img").Jcrop({onChange:b,onSelect:b,aspectRatio:f},function(){var n=this.getBounds();m.preview+="-thumb";l=this;j=n[0];i=n[1]})}};